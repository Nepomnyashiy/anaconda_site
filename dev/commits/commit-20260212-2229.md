# Отчёт по коммиту T-02

Дата: 2026-02-12 22:29

Что исправлено:
- Исправлен путь запуска Ansible playbook в GitHub Actions: `ansible/site.yml` заменён на `ansible/playbooks/site.yml`.
- Добавлен pre-step проверки файлов в CI с ранним завершением при ошибке.
- Добавлен шаблон `ansible/inventory/hosts.ini.example` и автогенерация `hosts.ini` в CI.
- Добавлены preflight-проверки в Ansible (ОС, sudo, apt, сеть, обязательные переменные, каталог деплоя).
- Добавлена роль Nginx с созданием отдельного vhost под проект и безопасной перезагрузкой через `nginx -t`.
- Обновлена документация по деплою, CI/CD, runbook и архитектуре.

Какие проверки добавлены:
- CI: проверка наличия `ansible/playbooks/site.yml` и `ansible/inventory/hosts.ini`.
- Playbook: assert по ОС и обязательным переменным, проверка sudo.
- Preflight роль: проверки apt, DNS/HTTP-доступности (с поддержкой `air_gap_mode`), проверка Docker.
- Nginx handler: валидация `nginx -t` перед reload.

Как проверить локально и в CI:
- Локально:
  - `ansible-playbook -i ansible/inventory/hosts.ini ansible/playbooks/site.yml --syntax-check`
  - `ansible-playbook -i ansible/inventory/hosts.ini ansible/playbooks/site.yml`
- В CI:
  - выполнить push в `main`;
  - убедиться, что шаг «Проверка наличия файлов» проходит и деплой запускается с корректным путём playbook.

Следующий шаг:
- T-03 Ansible prod deploy pull from GHCR.
