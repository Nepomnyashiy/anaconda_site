name: Deploy via Ansible

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
      DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
      DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
      DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Создать inventory и SSH-конфигурацию из Secrets
        shell: bash
        run: |
          set -euo pipefail

          # Проверяем обязательные секреты для генерации inventory.
          test -n "${DEPLOY_HOST:-}" || (echo "Ошибка: не задан секрет DEPLOY_HOST" >&2 && exit 1)
          test -n "${DEPLOY_USER:-}" || (echo "Ошибка: не задан секрет DEPLOY_USER" >&2 && exit 1)
          test -n "${DEPLOY_SSH_KEY:-}" || (echo "Ошибка: не задан секрет DEPLOY_SSH_KEY" >&2 && exit 1)

          mkdir -p ansible/inventory
          mkdir -p ~/.ssh

          # Записываем приватный ключ только во временную среду раннера.
          printf '%s\n' "${DEPLOY_SSH_KEY}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          # Добавляем отпечаток сервера в known_hosts для безопасного SSH.
          ssh-keyscan -H "${DEPLOY_HOST}" >> ~/.ssh/known_hosts

          # Генерируем inventory для продакшн-группы.
          printf '%s\n' \
            '[prod]' \
            "server1 ansible_host=${DEPLOY_HOST} ansible_user=${DEPLOY_USER} ansible_port=${DEPLOY_PORT:-22}" \
            '' \
            '[prod:vars]' \
            'ansible_become=true' \
            'ansible_become_method=sudo' \
            > ansible/inventory/hosts.ini

      - name: Проверка наличия файлов перед деплоем
        shell: bash
        run: |
          set -euo pipefail

          test -f ansible/inventory/hosts.ini || (echo "Ошибка: hosts.ini не создан" >&2 && exit 1)
          test -f ansible/playbooks/site.yml || (echo "Ошибка: playbook не найден" >&2 && exit 1)
          test -d ansible/roles/base || (echo "Ошибка: не найдена роль ansible/roles/base" >&2 && exit 1)
          test -d ansible/roles/deploy || (echo "Ошибка: не найдена роль ansible/roles/deploy" >&2 && exit 1)
          test -d ansible/roles/nginx || (echo "Ошибка: не найдена роль ansible/roles/nginx" >&2 && exit 1)

      - name: Deploy
        env:
          # Явно указываем конфиг из ansible/, чтобы Ansible видел roles_path
          # при запуске из корня репозитория в GitHub Actions.
          ANSIBLE_CONFIG: ansible/ansible.cfg
        run: ansible-playbook -i ansible/inventory/hosts.ini ansible/playbooks/site.yml
